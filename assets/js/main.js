var polls = 
[
	{
		"id": 1, 
		"titulo": "¿Qué personaje de los simpsons serías?", 
		"questions":
			[
				{
					"id_question": 1, 
					"imagen": "https://desempleotecnologico.files.wordpress.com/2013/07/work-relax.jpeg?w=500",
					"enunciado_question": "¿Qué te gusta más?", 
					"answers": 
						[
							{
								"id_answer": 1, 
								"enunciado_answer": "Comer donuts.", 
								"valor": 4 
							},
		 					{
		 						"id_answer": 2,
		 						"enunciado_answer": "Estudiar.",
		 						"valor": 1
		 					},
							{
								"id_answer": 3, 
								"enunciado_answer": "Hacer gamberradas.", 
								"valor": 2
							},
							{
								"id_answer": 4, 
								"enunciado_answer": "Servir copas.", 
								"valor": 6
							}
						]
				},  /*1ª question, 1ª poll*/

	 			{
	 				"id_question": 2, 
	 				"imagen": "http://www.quieroimagenes.com/i/Homer-trabajando-imagen.jpg",
	 				"enunciado_question": "¿Te gusta trabajar?", 
	 				"answers":
	 					[
	 						{
		 						"id_answer": 1, 
		 						"enunciado_answer": "Sí, mucho.", 
		 						"valor": 1
		 					},
							{
								"id_answer": 2, 
								"enunciado_answer": "No, nada.", 
								"valor": 5
							},
							{
								"id_answer": 3, 
								"enunciado_answer": "No mucho.", 
								"valor": 6
							}
	 					]
				},  /*2ª question, 1ª poll*/

				{
					"id_question": 3, 
					"imagen": "https://unaodoscopas.files.wordpress.com/2016/07/o_marcalpena_moes.jpg"	,
					"enunciado_question": "¿Qué preferirías hacer?", 
					"answers": 
						[
							{
								"id_answer": 1, 
								"enunciado_answer": "Comer, beber y dormir.", 
								"valor": 4
							},
							{
								"id_answer": 2, 
								"enunciado_answer": "Vacilar.", 
								"valor": 2
							},
							{
								"id_answer": 3, 
								"enunciado_answer": "Tocar el saxofón.", 
								"valor": 1
							},
							{
								"id_answer": 4, 
								"enunciado_answer": "Reirse de borrachos.", 
								"valor": 7
							}
						]
				}
			],	
		"soluciones": 
			[
				{
					"id_solucion": 1,
					"solucion": "Lisa Simpson",
					"imagen": "http://images.yodibujo.es/_uploads/_tiny_galerie/20130414/lisa-simpson-hija_6zs.jpg",
					"explicacion": "Eres una persona irresponsable, infantil, lenta y torpe. Te encanta la comida, e ir al bar a beber birras. Pero algo bueno tienes, eres muy agradable, gracioso y fiel.",
					"rango": [1,5]
				},
				{
					"id_solucion": 1,
					"solucion": "Bart Simpson",
					"imagen": "https://upload.wikimedia.org/wikipedia/en/a/aa/Bart_Simpson_200px.png",
					"explicacion": "Eres una persona irresponsable, infantil, lenta y torpe. Te encanta la comida, e ir al bar a beber birras. Pero algo bueno tienes, eres muy agradable, gracioso y fiel.",
					"rango": [6,10]
				},
				{
					"id_solucion": 1,
					"solucion": "Homer Simpson",
					"imagen": "http://interactive.nydailynews.com/2016/05/simpsons-quiz/img/simp1.jpg",
					"explicacion": "Eres una persona irresponsable, infantil, lenta y torpe. Te encanta la comida, e ir al bar a beber birras. Pero algo bueno tienes, eres muy agradable, gracioso y fiel.",
					"rango": [11,15]
				},
				{
					"id_solucion": 1,
					"solucion": "Moe Szyslak",
					"imagen": "http://s03.s3c.es/imag/_v0/640x300/1/1/c/moe.jpg",
					"explicacion": "Eres una persona irresponsable, infantil, lenta y torpe. Te encanta la comida, e ir al bar a beber birras. Pero algo bueno tienes, eres muy agradable, gracioso y fiel.",
					"rango": [16,20]
				}
			]
	},

	{
		"id": 2, 
		"titulo": "¿Qué personaje de los Simpsons serías?", 
		"questions":
			[
				{
					"id_question": 1, 
					"imagen": "https://vignette.wikia.nocookie.net/inciclopedia/images/d/d7/Lisa_simpson_1.gif/revision/latest?cb=20090202033921",
					"enunciado_question": "¿Qué te gusta más?", 
					"answers": 
						[
							{
								"id_answer": 1, 
								"enunciado_answer": "Comer donuts.", 
								"valor": 4 
							},
		 					{
		 						"id_answer": 2,
		 						"enunciado_answer": "Estudiar.",
		 						"valor": 1
		 					},
							{
								"id_answer": 3, 
								"enunciado_answer": "Hacer gamberradas.", 
								"valor": 2
							},
							{
								"id_answer": 4, 
								"enunciado_answer": "Servir copas.", 
								"valor": 6
							}
						]
				},  /*1ª question, 1ª poll*/

	 			{
	 				"id_question": 2, 
	 				"imagen": "http://www.puzzlesonline.es/puzzles/2015/simpsons/tirachinasdebart.jpg",
	 				"enunciado_question": "¿Te gusta trabajar?", 
	 				"answers":
	 					[
	 						{
		 						"id_answer": 1, 
		 						"enunciado_answer": "Sí, mucho.", 
		 						"valor": 1
		 					},
							{
								"id_answer": 2, 
								"enunciado_answer": "No, nada.", 
								"valor": 5
							},
							{
								"id_answer": 3, 
								"enunciado_answer": "No mucho.", 
								"valor": 6
							}
	 					]
				},  /*2ª question, 1ª poll*/

				{
					"id_question": 3, 
					"imagen": "http://www.freakingnews.com/pictures/37000/Homer-Asleep-on-a-Sofa-37122.jpg",
					"enunciado_question": "¿Qué preferirías hacer?", 
					"answers": 
						[
							{
								"id_answer": 1, 
								"enunciado_answer": "Comer, beber y dormir.", 
								"valor": 4
							},
							{
								"id_answer": 2, 
								"enunciado_answer": "Vacilar.", 
								"valor": 2
							},
							{
								"id_answer": 3, 
								"enunciado_answer": "Tocar el saxofón.", 
								"valor": 1
							},
							{
								"id_answer": 4, 
								"enunciado_answer": "Reirse de borrachos.", 
								"valor": 7
							}
						]
				}
			]
	},

];

var comment = [
	{
		"id_comment": 1,
		"texto": "¡Hola! Este es un comment prueba de un user anónimo."
	},
	{
		"id_comment": 2,
		"texto": "Por el momento solo habrá comments anónimos, pero es muy posible que se añadan users en futuras versiones."
	},
	{
		"id_comment": 3,
		"texto": "Por ahora tampoco se pude responder a un comment directamente. También se añadirá dicha funcionalidad."
	}
];

var puntuacion = 0;
var Id_poll = 1;
var PPos = 0;
var key = null;
var pos = 0;
var printed = 0;




// FUNCIÓN ONLOAD QUE INICIALIZA VARIAS FUNCIONES
function cargar(){
	$(window).on('scroll',function(){
	    navbar();	
	});
	imprimirPoll(getEPos());
	imprimirSavedComments();
}

//FUNCION PARA MODIFICAR EL NAVBAR
function navbar(){
	var poll = $('#poll').offset().top;
	var stop = Math.round($(window).scrollTop());
	if (key) {
    	if (stop >= poll) {
	    	$("#nav").removeClass("navbar-light");
	        $('#nav').addClass('navbar-dark');
	        $('#nav').css("background-color", "black");
	        $("#nav").animate({height: "60px"});
	        key = false;
    	}
    } else if (!key){
    	if (stop < poll) {
	    	$("#nav").removeClass("navbar-dark");
	        $('#nav').css("background-color", "#EDDBF3");
	        $('#nav').addClass('navbar-light');
	        $("#nav").animate({height: "100px"});
	        key = true;
	    }
    }  

    if (key == null){
    	if (stop >= poll) {
	    	$("#nav").removeClass("navbar-light");
	        $('#nav').addClass('navbar-dark');
	        $('#nav').css("background-color", "black");
	        $("#nav").css("height", "60px");
	        key = false;
    	} else if (stop < poll) {
	    	$("#nav").removeClass("navbar-dark");
	        $('#nav').css("background-color", "#EDDBF3");
	        $('#nav').addClass('navbar-light');
	        $("#nav").css("height", "100px");
	        key = true;
	    }
    }  	
}

// FUNCION QUE SACA LAS PREGUNTAS Y RESPUESTAS
function imprimirPoll(id_poll){
	for (var i = 0; i < polls.length; i++){
		if (id_poll === polls[i].id) {
			this.pos = i;
		}
	}
		//datos poll
	var id_poll = polls[pos].id;
	var titulo = polls[pos].titulo;
	// create titulo de la poll
	var h1 = document.createElement("h1");
	h1.setAttribute("id", "titulo_poll_h1");
	h1.innerHTML = titulo;
	//$("#titulo_poll").append(h1);
	$(h1).hide().appendTo("#poll").fadeIn(1000);
	imprimirQuestions(getEPos(), this.pos, getPPos());	
}

function imprimirQuestions(id_poll, pos, pos_question){
		//datos question
	var id_question = polls[pos].questions[pos_question].id_question;
	var enunciado_question = polls[pos].questions[pos_question].enunciado_question;
	var ruta_img = polls[pos].questions[pos_question].imagen;

	// create imagen de la question
	var img = document.createElement("img");
	img.setAttribute("src", ruta_img);
	img.setAttribute("class", "img-fluid rounded");
	$(img).hide().appendTo("#img_poll").fadeIn(1000);
	//$("#img_poll").append(img);

	// create enunciado de la question
	var h4 = document.createElement("h4");
	h4.setAttribute("id", "enunciado_question_h4");
	h4.innerHTML = enunciado_question;
	$(h4).hide().appendTo("#question").fadeIn(1000);
	//$("#question").append(h4);

	// create answers de la question
	for (var j = 0; j < polls[pos].questions[pos_question].answers.length; j++){
		//datos answer
		var id_answer = polls[pos].questions[pos_question].answers[j].id_answer;
		var enunciado_answer = polls[pos].questions[pos_question].answers[j].enunciado_answer; 
		

		var div = document.createElement("div");
	    div.setAttribute("class", "col-12 justify-content-center text-center");
	    div.setAttribute("style", "padding-bottom:20px");

		var answer = document.createElement("input");
	    answer.setAttribute("type", "button");
	    answer.setAttribute("id", id_answer);
	    answer.setAttribute("class", "btn btn-dark btn-width");
	    answer.setAttribute("value", enunciado_answer);
	    answer.setAttribute("data-idResponse", id_answer);
	    answer.setAttribute("data-idQuestion", id_question);
	    answer.setAttribute("data-idPoll", id_poll);
	    answer.setAttribute("onclick", "accion(this)");

	    $(answer).hide().appendTo(div).fadeIn(1000);
    	//div.append(answer);
	   
		//$("#div_answers").append(div);
		$(div).hide().appendTo("#div_answers").fadeIn(1000);
		setPPos(pos_question + 1);
		//progress bar
		var num_preg = polls[pos].questions.length;
		var newWidth = id_question / num_preg * 100;
		progress(newWidth);
	}
	this.printed ++;
}

// funcion que imprime el result

function imprimirSolucion(pos){
	
	//$("#titulo_poll").append(h1);

	for (var i = 0; i < polls[pos].soluciones.length; i++){
		console.log(polls[pos].soluciones[i].rango[0]);
		if ((polls[pos].soluciones[i].rango[0]) <= (this.puntuacion) && (this.puntuacion) <= (polls[pos].soluciones[i].rango[1])){
			var solucion = polls[pos].soluciones[i].solucion;
			var ruta = polls[pos].soluciones[i].imagen;
			var explicacion = polls[pos].soluciones[i].explicacion;

			var h1 = document.createElement("h1");
			h1.innerHTML = solucion;
			$(h1).hide().appendTo("#titulo_poll").fadeIn(1000);

			var img = document.createElement("img");
			img.setAttribute("src", ruta);
			$(img).hide().appendTo("#img_poll").fadeIn(1000);

			var result = document.createElement("p");
			result.innerHTML = explicacion;
			$(result).hide().appendTo("#question").fadeIn(1000);
		}
	}
}

// funcion que realizan los botones de las answers
function accion(boton){
	var id = boton.id;
	var selfPoll;
	var selfQuestion;
	var selfAnswer;
	var selfValor;
	for (var i = 0; i < polls.length; i++){
		if ($(boton).attr("data-idPoll") == polls[i].id){
			selfPoll = polls[i];
			for (var j = 0; j < polls[i].questions.length; j++) {
				if ($(boton).attr("data-idQuestion") == polls[i].questions[j].id_question) {
					selfQuestion =  polls[i].questions[j];
				}
			}
		}
	}
	
	for (var h = 0; h < selfQuestion.answers.length; h++){
		if ($(boton).attr("data-idResponse") == selfQuestion.answers[h].id_answer) {
			selfAnswer = selfQuestion.answers[h];
		}
	}

	selfValor = selfAnswer.valor;
	setPuntuacion(selfValor);
	limpiarSalida();
	// si el numero de questions impresas es igual al total de questions de esa poll, sacamos el result
	if (this.printed == polls[this.pos].questions.length){
		imprimirSolucion(this.pos);
	} else {
		imprimirQuestions(getEPos(), this.pos, getPPos());	
	}
}

// funcion que resetea la question y los botones
function limpiarSalida(){
	$("#titulo_poll").empty();
	$("#img_poll").empty();
	$("#question").empty();
	$("#div_answers").empty();
}

// funcion que saca por pantalla los comments ya guardados
function imprimirSavedComments(){
	for (var i = 0; i < comment.length; i++){
		// creo div row
			var div = document.createElement("div");
			div.setAttribute("class", "row");
			div.setAttribute("style", "margin-bottom: 25px");

				// creo div col 1
				var div1 = document.createElement("div");
		    	div1.setAttribute("class", "col-sm-2 text-center");

		    		// creo img de div1
		    		var img = document.createElement("img");
				    img.setAttribute("src", "https://png.icons8.com/metro/1600/gender-neutral-user.png");
				    img.setAttribute("class", "img-circle");
				    img.setAttribute("height", "65");
				    img.setAttribute("width", "65");
				    img.setAttribute("alt", "avatar");

				// meto img en div1
				$(img).hide().appendTo(div1).fadeIn(1000);
		    	//div1.append(img);

		    	// creo div col 2
			    var div2 = document.createElement("div");
			    div2.setAttribute("class", "col-sm-10");
			    div2.setAttribute("style", "margin-bottom: 10px");

			    	// creo p de div2
				    var p = document.createElement("p");
				    p.innerHTML = comment[comment.length-1].texto;
			    // meto p en div 2
			    //div2.append(p);
			    $(p).hide().appendTo(div2).fadeIn(1000);
		    // meto div1 y div2 en div row
		    $(div1).hide().appendTo(div).fadeIn(1000);
		    $(div2).hide().appendTo(div).fadeIn(1000);
		    //div.append(div1);
		    //div.append(div2);
		    //meto div row en div row rowComment
		    $(div).hide().appendTo("#rowComment").fadeIn(1000);
		    //$("#rowComment").append(div);
		    $("#coment").val("");
	}
}
// funcion que imprime los comments nuevos y los guarda (temporalmente)
function imprimirComments(){
	var texto = $("#coment").val();
	if (texto != "") {
		size = comment.length;
		var prevId = comment[size - 1].id_comment;
		var newId = prevId + 1;
		comment.push({"id_comment": newId, "texto": texto});
		if (comment[size].texto != ""){
			// creo div row
			var div = document.createElement("div");
			div.setAttribute("class", "row");
			div.setAttribute("style", "margin-bottom: 25px");

				// creo div col 1
				var div1 = document.createElement("div");
		    	div1.setAttribute("class", "col-sm-2 text-center");

		    		// creo img de div1
		    		var img = document.createElement("img");
				    img.setAttribute("src", "https://png.icons8.com/metro/1600/gender-neutral-user.png");
				    img.setAttribute("class", "img-circle");
				    img.setAttribute("height", "65");
				    img.setAttribute("width", "65");
				    img.setAttribute("alt", "avatar");

				// meto img en div1
				$(img).hide().appendTo(div1).fadeIn(1000);
		    	//div1.append(img);

		    	// creo div col 2
			    var div2 = document.createElement("div");
			    div2.setAttribute("class", "col-sm-10");
			    div2.setAttribute("style", "margin-bottom: 10px");

			    	// creo p de div2
				    var p = document.createElement("p");
				    p.innerHTML = comment[size].texto;
			    // meto p en div 2
			    //div2.append(p);
			    $(p).hide().appendTo(div2).fadeIn(1000);
		    // meto div1 y div2 en div row
		    $(div1).hide().appendTo(div).fadeIn(1000);
		    $(div2).hide().appendTo(div).fadeIn(1000);
		    //div.append(div1);
		    //div.append(div2);
		    //meto div row en div row rowComment
		    $(div).hide().appendTo("#rowComment").fadeIn(1000);
		    //$("#rowComment").append(div);
		    $("#coment").val("");
		}
	} else {
		/*var alerta = document.createElement("div");
		alerta.setAttribute("class", "alert alert-success");
		alerta.innerHTML = "strong>Introduzca texto en la casilla de comments.</strong>";

		var a = document.createElement("a");
		a.setAttribute("href", "#");
		a.setAttribute("class", "close");
		a.setAttribute("data-dismiss", "alert");
		a.setAttribute("aria-label", "close");
		a.innerHTML = "&times;" ;

		alerta.append(a);*/
	}	
}

//funcion que elimina la salida de los comments
function limpiarComments(){
	$("#rowComment").empty();
}

// funcion que actualiza la barra de progreso
function progress(newWidth){
	$("#PBar").css({width: newWidth + "%"});
	$("#PBar").val(newWidth + "%");
}


// GETTERS Y SETTERS
function setEPos(EPos){
	this.Id_poll = Id_poll;
}

function getEPos(){
	return this.Id_poll;
}

function setPPos(PPos){
	this.PPos = PPos;
}

function getPPos(){
	return this.PPos;
}

function setPuntuacion(nueva_puntuacion){
	this.puntuacion += nueva_puntuacion;
}

function getPuntuacion(){
	return this.puntuacion;
}